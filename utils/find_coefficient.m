function [a1,b1,c1,d1,t11,t21] = find_coefficient(k3,k4,k5,u,v,u1,v1,J21a,J21b,J21c,J21d,J12a,J12b,J12c,J12d,H21uua,H21uub,H21uva,H21uvb,H21vva,H21vvb)

% christoffel symbols at surface 1

%second order derivatives at surface 1
k31 = repmat(k3(1,:),size(u,1),1);
k41 = repmat(k4(1,:),size(u,1),1);
k51 = repmat(k5(1,:),size(u,1),1);

%coeff of k1               % coeff of k2              %constant term
T110 = -2 +(1+u1.^2).*k31; T101 = u1.*v1.*k31;        T100 = -u1.*k31;
T210 = u1.*v1.*k31;         T201 = (1+v1.^2).*k31;     T200 = -v1.*k31;
T310 = (1+u1.^2).*k41;     T301 = u1.*v1.*k41 -1;     T300 = -u1.*k41;
T410 = u1.*v1.*k41 -1 ;     T401 = (1+v1.^2).*k41;     T400 = -v1.*k41;
T510 = (1+u1.^2).*k51;     T501 = u1.*v1.*k51;        T500 = -u1.*k51;
T610 = u1.*v1.*k51;        T601 = -2 +(1+v1.^2).*k51; T600 = -v1.*k51;

% pullback of christoffel symbols
T1b10 = J12a.*(T110.*J21a.^2 + 2*(T310.*J21a.*J21b) + T510.*J21b.^2) + ...
        J12c.*(T210.*J21a.^2 + 2*(T410.*J21a.*J21b) + T610.*J21b.^2) + J12a.*H21uua + J12c.*H21uub;
T1b01 = J12a.*(T101.*J21a.^2 + 2*(T301.*J21a.*J21b) + T501.*J21b.^2) + ...
        J12c.*(T201.*J21a.^2 + 2*(T401.*J21a.*J21b) + T601.*J21b.^2) + J12a.*H21uua + J12c.*H21uub;
T1b00 = J12a.*(T100.*J21a.^2 + 2*(T300.*J21a.*J21b) + T500.*J21b.^2) + ...
        J12c.*(T200.*J21a.^2 + 2*(T400.*J21a.*J21b) + T600.*J21b.^2) + J12a.*H21uua + J12c.*H21uub;

T2b10 = J12b.*(T110.*J21a.^2 + 2*(T310.*J21a.*J21b) + T510.*J21b.^2) + ...
        J12d.*(T210.*J21a.^2 + 2*(T410.*J21a.*J21b) + T610.*J21b.^2) + J12b.*H21uua + J12d.*H21uub;
T2b01 = J12b.*(T101.*J21a.^2 + 2*(T301.*J21a.*J21b) + T501.*J21b.^2) + ...
        J12d.*(T201.*J21a.^2 + 2*(T401.*J21a.*J21b) + T601.*J21b.^2) + J12b.*H21uua + J12d.*H21uub;
T2b00 = J12b.*(T100.*J21a.^2 + 2*(T300.*J21a.*J21b) + T500.*J21b.^2) + ...
        J12d.*(T200.*J21a.^2 + 2*(T400.*J21a.*J21b) + T600.*J21b.^2) + J12b.*H21uua + J12d.*H21uub;
    
T3b00 = J12a.*(T110.*J21a.*J21c + T310.*(J21a.*J21d+J21b.*J21c) + T510.*J21b.*J21d) + ...
        J12c.*(T210.*J21a.*J21c + T410.*(J21a.*J21d+J21b.*J21c) + T610.*J21b.*J21d) + J12a.*H21uva + J12c.*H21uvb;
T3b01 = J12a.*(T101.*J21a.*J21c + T301.*(J21a.*J21d+J21b.*J21c) + T501.*J21b.*J21d) + ...
        J12c.*(T201.*J21a.*J21c + T401.*(J21a.*J21d+J21b.*J21c) + T601.*J21b.*J21d) + J12a.*H21uva + J12c.*H21uvb;
T3b00 = J12a.*(T100.*J21a.*J21c + T300.*(J21a.*J21d+J21b.*J21c) + T500.*J21b.*J21d) + ...
        J12c.*(T200.*J21a.*J21c + T400.*(J21a.*J21d+J21b.*J21c) + T600.*J21b.*J21d) + J12a.*H21uva + J12c.*H21uvb;

T4b10 = J12b.*(T110.*J21a.*J21c + T310.*(J21a.*J21d+J21b.*J21c) + T510.*J21b.*J21d) + ...
        J12d.*(T210.*J21a.*J21c + T410.*(J21a.*J21d+J21b.*J21c) + T610.*J21b.*J21d) + J12b.*H21uva + J12d.*H21uvb;
T4b01 = J12b.*(T101.*J21a.*J21c + T301.*(J21a.*J21d+J21b.*J21c) + T501.*J21b.*J21d) + ...
        J12d.*(T201.*J21a.*J21c + T401.*(J21a.*J21d+J21b.*J21c) + T601.*J21b.*J21d) + J12b.*H21uva + J12d.*H21uvb;
T4b00 = J12b.*(T100.*J21a.*J21c + T300.*(J21a.*J21d+J21b.*J21c) + T500.*J21b.*J21d) + ...
        J12d.*(T200.*J21a.*J21c + T400.*(J21a.*J21d+J21b.*J21c) + T600.*J21b.*J21d) + J12b.*H21uva + J12d.*H21uvb;

T5b10 = J12a.*(T110.*J21c.^2 + 2*(T310.*J21c.*J21d) + T510.*J21d.^2) + ...
        J12c.*(T210.*J21c.^2 + 2*(T410.*J21c.*J21d) + T610.*J21d.^2) + J12a.*H21vva + J12c.*H21vvb;
T5b01 = J12a.*(T101.*J21c.^2 + 2*(T301.*J21c.*J21d) + T501.*J21d.^2) + ...
        J12c.*(T201.*J21c.^2 + 2*(T401.*J21c.*J21d) + T601.*J21d.^2) + J12a.*H21vva + J12c.*H21vvb;
T5b00 = J12a.*(T100.*J21c.^2 + 2*(T300.*J21c.*J21d) + T500.*J21d.^2) + ...
        J12c.*(T200.*J21c.^2 + 2*(T400.*J21c.*J21d) + T600.*J21d.^2) + J12a.*H21vva + J12c.*H21vvb;

T6b10 = J12b.*(T110.*J21c.^2 + 2*(T310.*J21c.*J21d) + T510.*J21d.^2) + ...
        J12d.*(T210.*J21c.^2 + 2*(T410.*J21c.*J21d) + T610.*J21d.^2) + J12b.*H21vva + J12d.*H21vvb;
T6b01 = J12b.*(T101.*J21c.^2 + 2*(T301.*J21c.*J21d) + T501.*J21d.^2) + ...
        J12d.*(T201.*J21c.^2 + 2*(T401.*J21c.*J21d) + T601.*J21d.^2) + J12b.*H21vva + J12d.*H21vvb;
T6b00 = J12b.*(T100.*J21c.^2 + 2*(T300.*J21c.*J21d) + T500.*J21d.^2) + ...
        J12d.*(T200.*J21c.^2 + 2*(T400.*J21c.*J21d) + T600.*J21d.^2) + J12b.*H21vva + J12d.*H21vvb; 

% find relation between k1_bar,k2_bar and k1,k2


k3b = k3(2:end,:);
k4b = k4(2:end,:);
k5b = k5(2:end,:);

%coeff of k1              % coeff of k2            %constant term
M11 = -2 +(1+u.^2).*k3b; M12 = u.*v.*k3b;         M13 = -u.*k3b;
M21 = u.*v.*k3b;         M22 = (1+v.^2).*k3b;     M23 = -v.*k3b;
M31 = (1+u.^2).*k4b;     M32 = u.*v.*k4b -1;      M33 = -u.*k4b;
M41 = u.*v.*k4b -1;      M42 = (1+v.^2).*k4b;     M43 = -v.*k4b;
M51 = (1+u.^2).*k5b;     M52 = u.*v.*k5b;         M53 = -u.*k5b;
M61 = u.*v.*k5b;         M62 = -2 +(1+v.^2).*k5b; M63 = -v.*k5b;

% M'*M
Md11 = M11.^2 + M21.^2 + M31.^2 + M41.^2 + M51.^2 + M61.^2;
Md12 = M11.*M12 + M21.*M22 + M31.*M32 + M41.*M42 + M51.*M52 + M61.*M62;
Md13 = M11.*M13 + M21.*M23 + M31.*M33 + M41.*M43 + M51.*M53 + M61.*M63;
Md21 = M11.*M12 + M21.*M22 + M31.*M32 + M41.*M42 + M51.*M52 + M61.*M62;
Md22 = M12.^2 + M22.^2 + M32.^2 + M42.^2 + M52.^2 + M62.^2;
Md23 = M12.*M13 + M22.*M23 + M32.*M33 + M42.*M43 + M52.*M53 + M62.*M63;
Md31 = M11.*M13 + M21.*M23 + M31.*M33 + M41.*M43 + M51.*M53 + M61.*M63;
Md32 = M12.*M13 + M22.*M23 + M32.*M33 + M42.*M43 + M52.*M53 + M62.*M63;
Md33 = M13.^2 + M23.^2 + M33.^2 + M43.^2 + M53.^2 + M63.^2;
 
%K = inv(M'*M)*(M'*[T1;T2;T3;T4;T5;T6])

a1 = ((Md12.*Md23-Md13.*Md22).*(M13.*T110+M23.*T210+M33.*T310+M43.*T410+M53.*T510+M63.*T610))./(Md11.*Md22.*Md33-...
       Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md12.*Md33- ...
       Md13.*Md32).*(M12.*T110+M22.*T210+M32.*T310+M42.*T410+M52.*T510+M62.*T610))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32 - ...
       Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)+((Md22.*Md33-Md23.*Md32).*(M11.*T110+M21.*T210 +...
       M31.*T310+M41.*T410+M51.*T510+M61.*T610))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+...
       Md13.*Md21.*Md32-Md13.*Md22.*Md31);
   
b1 = ((Md12.*Md23-Md13.*Md22).*(M13.*T101+M23.*T201+M33.*T301+M43.*T401+M53.*T501+M63.*T601))./(Md11.*Md22.*Md33-...
       Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md12.*Md33- ...
       Md13.*Md32).*(M12.*T101+M22.*T201+M32.*T301+M42.*T401+M52.*T501+M62.*T601))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32 - ...
       Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)+((Md22.*Md33-Md23.*Md32).*(M11.*T101+M21.*T201 +...
       M31.*T301+M41.*T401+M51.*T501+M61.*T601))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+...
       Md13.*Md21.*Md32-Md13.*Md22.*Md31);
   
t11 = ((Md12.*Md23-Md13.*Md22).*(M13.*T100+M23.*T200+M33.*T300+M43.*T400+M53.*T500+M63.*T600))./(Md11.*Md22.*Md33-...
       Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md12.*Md33- ...
       Md13.*Md32).*(M12.*T100+M22.*T200+M32.*T300+M42.*T400+M52.*T500+M62.*T600))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32 - ...
       Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)+((Md22.*Md33-Md23.*Md32).*(M11.*T100+M21.*T200+...
       M31.*T300+M41.*T400+M51.*T500+M61.*T600))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+...
       Md13.*Md21.*Md32-Md13.*Md22.*Md31);
   
c1 = ((Md11.*Md33-Md13.*Md31).*(M12.*T110+M22.*T210+M32.*T310+M42.*T410+M52.*T510+M62.*T610))./(Md11.*Md22.*Md33-...
    Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md11.*Md23-...
    Md13.*Md21).*(M13.*T110+M23.*T210+M33.*T310+M43.*T410+M53.*T510+M63.*T610))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32 - ...
    Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md21.*Md33-Md23.*Md31).*(M11.*T110+M21.*T210 +...
    M31.*T310+M41.*T410+M51.*T510+M61.*T610))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31 +...
    Md13.*Md21.*Md32 - Md13.*Md22.*Md31);

d1 = ((Md11.*Md33-Md13.*Md31).*(M12.*T101+M22.*T201+M32.*T301+M42.*T401+M52.*T501+M62.*T601))./(Md11.*Md22.*Md33-...
    Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md11.*Md23-...
    Md13.*Md21).*(M13.*T101+M23.*T201+M33.*T301+M43.*T401+M53.*T501+M63.*T601))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32 - ...
    Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md21.*Md33-Md23.*Md31).*(M11.*T101+M21.*T201 +...
    M31.*T301+M41.*T401+M51.*T501+M61.*T601))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31 +...
    Md13.*Md21.*Md32 - Md13.*Md22.*Md31);

t21 = ((Md11.*Md33-Md13.*Md31).*(M12.*T100+M22.*T200+M32.*T300+M42.*T400+M52.*T500+M62.*T600))./(Md11.*Md22.*Md33-...
    Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md11.*Md23-...
    Md13.*Md21).*(M13.*T100+M23.*T200+M33.*T300+M43.*T400+M53.*T500+M63.*T600))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32 - ...
    Md12.*Md21.*Md33+Md12.*Md23.*Md31+Md13.*Md21.*Md32-Md13.*Md22.*Md31)-((Md21.*Md33-Md23.*Md31).*(M11.*T100+M21.*T200 +...
    M31.*T300+M41.*T400+M51.*T500+M61.*T600))./(Md11.*Md22.*Md33-Md11.*Md23.*Md32-Md12.*Md21.*Md33+Md12.*Md23.*Md31 +...
    Md13.*Md21.*Md32 - Md13.*Md22.*Md31);
 
